<UserControl x:Class="Dorisoy.Meeting.Client.Views.ChatPanel"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             xmlns:models="clr-namespace:Dorisoy.Meeting.Client.Models"
             Background="{DynamicResource ControlFillColorDefaultBrush}">

    <UserControl.Resources>
        <!-- 消息气泡模板 -->
        <DataTemplate x:Key="ChatMessageTemplate" DataType="{x:Type models:ChatMessage}">
            <Grid Margin="8,4">
                <!-- 自己发送的消息 -->
                <Border HorizontalAlignment="Right"
                        MaxWidth="280"
                        Visibility="{Binding IsFromSelf, Converter={StaticResource BoolToVisConverter}}">
                    <StackPanel>
                        <TextBlock Text="{Binding FormattedTime}"
                                   HorizontalAlignment="Right"
                                   FontSize="10"
                                   Opacity="0.5"
                                   Margin="0,0,0,2"/>
                        <Border Background="#0078D4"
                                CornerRadius="12,12,4,12"
                                Padding="12,8">
                            <Grid>
                                <!-- 文本消息 -->
                                <TextBlock Text="{Binding Content}"
                                           Foreground="White"
                                           TextWrapping="Wrap"
                                           FontSize="13"
                                           Visibility="{Binding MessageType, Converter={StaticResource TextMessageVisibilityConverter}}"/>
                                
                                <!-- 图片消息 -->
                                <StackPanel Visibility="{Binding MessageType, Converter={StaticResource ImageMessageVisibilityConverter}}">
                                    <Image Source="{Binding ImageSource}"
                                           MaxWidth="200"
                                           MaxHeight="200"
                                           Stretch="Uniform"
                                           Margin="0,0,0,4"/>
                                    <TextBlock Text="{Binding FileName}"
                                               Foreground="White"
                                               FontSize="11"
                                               Opacity="0.8"/>
                                </StackPanel>
                                
                                <!-- 文件消息 -->
                                <StackPanel Orientation="Horizontal" 
                                            Visibility="{Binding MessageType, Converter={StaticResource FileMessageVisibilityConverter}}">
                                    <ui:SymbolIcon Symbol="Document24" FontSize="24" Foreground="White" Margin="0,0,8,0"/>
                                    <StackPanel VerticalAlignment="Center">
                                        <TextBlock Text="{Binding FileName}"
                                                   Foreground="White"
                                                   FontSize="13"
                                                   TextTrimming="CharacterEllipsis"
                                                   MaxWidth="150"/>
                                        <TextBlock Text="{Binding FormattedFileSize}"
                                                   Foreground="White"
                                                   FontSize="11"
                                                   Opacity="0.7"/>
                                    </StackPanel>
                                </StackPanel>
                            </Grid>
                        </Border>
                    </StackPanel>
                </Border>
                
                <!-- 他人发送的消息 -->
                <StackPanel HorizontalAlignment="Left"
                            Visibility="{Binding IsFromSelf, Converter={StaticResource InverseBoolToVisConverter}}">
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,2">
                        <TextBlock Text="{Binding SenderName}"
                                   FontSize="11"
                                   FontWeight="SemiBold"
                                   Opacity="0.7"
                                   Margin="0,0,8,0"/>
                        <TextBlock Text="{Binding FormattedTime}"
                                   FontSize="10"
                                   Opacity="0.5"/>
                    </StackPanel>
                    <Border Background="{DynamicResource ControlFillColorSecondaryBrush}"
                            CornerRadius="12,12,12,4"
                            Padding="12,8"
                            MaxWidth="280">
                        <Grid>
                            <!-- 文本消息 -->
                            <TextBlock Text="{Binding Content}"
                                       TextWrapping="Wrap"
                                       FontSize="13"
                                       Visibility="{Binding MessageType, Converter={StaticResource TextMessageVisibilityConverter}}"/>
                            
                            <!-- 图片消息 -->
                            <StackPanel Visibility="{Binding MessageType, Converter={StaticResource ImageMessageVisibilityConverter}}">
                                <Image Source="{Binding ImageSource}"
                                       MaxWidth="200"
                                       MaxHeight="200"
                                       Stretch="Uniform"
                                       Margin="0,0,0,4"/>
                                <TextBlock Text="{Binding FileName}"
                                           FontSize="11"
                                           Opacity="0.6"/>
                            </StackPanel>
                            
                            <!-- 文件消息 -->
                            <Border Background="{DynamicResource ControlFillColorTertiaryBrush}"
                                    CornerRadius="8"
                                    Padding="8"
                                    Cursor="Hand"
                                    Visibility="{Binding MessageType, Converter={StaticResource FileMessageVisibilityConverter}}"
                                    MouseLeftButtonDown="FileMessage_Click">
                                <StackPanel Orientation="Horizontal">
                                    <ui:SymbolIcon Symbol="Document24" FontSize="24" Margin="0,0,8,0"/>
                                    <StackPanel VerticalAlignment="Center">
                                        <TextBlock Text="{Binding FileName}"
                                                   FontSize="13"
                                                   TextTrimming="CharacterEllipsis"
                                                   MaxWidth="150"/>
                                        <TextBlock Text="{Binding FormattedFileSize}"
                                                   FontSize="11"
                                                   Opacity="0.6"/>
                                    </StackPanel>
                                    <ui:SymbolIcon Symbol="ArrowDownload24" FontSize="18" Margin="8,0,0,0" Opacity="0.6"/>
                                </StackPanel>
                            </Border>
                        </Grid>
                    </Border>
                </StackPanel>
            </Grid>
        </DataTemplate>

        <!-- 用户列表模板 -->
        <DataTemplate x:Key="ChatUserTemplate" DataType="{x:Type models:ChatUser}">
            <Border Padding="8,6"
                    Cursor="Hand"
                    Background="Transparent">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- 头像 -->
                    <Border Grid.Column="0"
                            Width="36" Height="36"
                            CornerRadius="18"
                            Background="{DynamicResource ControlFillColorTertiaryBrush}"
                            Margin="0,0,10,0">
                        <Grid>
                            <TextBlock Text="{Binding DisplayName[0]}"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"
                                       FontSize="14"
                                       FontWeight="SemiBold"/>
                            <!-- 被主持人静音标识 -->
                            <Border HorizontalAlignment="Right"
                                    VerticalAlignment="Bottom"
                                    Margin="0,0,-2,-2"
                                    Background="#E81123"
                                    CornerRadius="7"
                                    Width="14" Height="14"
                                    Visibility="{Binding IsMutedByHost, Converter={StaticResource BoolToVisConverter}}">
                                <ui:SymbolIcon Symbol="MicOff16" FontSize="8" Foreground="White"/>
                            </Border>
                        </Grid>
                    </Border>
                    
                    <!-- 名称 -->
                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="{Binding DisplayName}"
                                       FontSize="13"
                                       FontWeight="Medium"/>
                            <!-- 主持人标识图标 -->
                            <Border Margin="4,0,0,0"
                                    VerticalAlignment="Center"
                                    Visibility="{Binding IsHost, Converter={StaticResource BoolToVisConverter}}">
                                <ui:SymbolIcon Symbol="Star12" 
                                               FontSize="12" 
                                               Foreground="#FFD700"
                                               ToolTip="主持人"/>
                            </Border>
                            <!-- 静音状态文字 -->
                            <TextBlock Text="(已静音)"
                                       FontSize="11"
                                       Foreground="#E81123"
                                       Margin="4,0,0,0"
                                       VerticalAlignment="Center"
                                       Visibility="{Binding IsMutedByHost, Converter={StaticResource BoolToVisConverter}}"/>
                        </StackPanel>
                        <TextBlock Text="{Binding LastMessagePreview}"
                                   HorizontalAlignment="Left"
                                   FontSize="11"
                                   Opacity="0.6"
                                   TextTrimming="CharacterEllipsis"
                                   MaxWidth="100"/>
                    </StackPanel>
                    
                    <!-- 主持人控制按钮（仅主持人可见） -->
                    <StackPanel Grid.Column="2"
                                Orientation="Horizontal"
                                VerticalAlignment="Center"
                                Margin="4,0"
                                Visibility="{Binding DataContext.IsHost, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource BoolToVisConverter}}">
                        <!-- 静音/取消静音按钮 -->
                        <ui:Button Appearance="Transparent"
                                   Padding="4"
                                   Margin="0,0,2,0"
                                   ToolTip="{Binding IsMutedByHost, Converter={StaticResource MuteTooltipConverter}}"
                                   Command="{Binding DataContext.MuteUserCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                   CommandParameter="{Binding}">
                            <Grid>
                                <!-- 静音图标（当前未静音） -->
                                <ui:SymbolIcon Symbol="MicOff16" FontSize="14"
                                               Foreground="#FFA500"
                                               Visibility="{Binding IsMutedByHost, Converter={StaticResource InverseBoolToVisConverter}}"/>
                                <!-- 取消静音图标（当前已静音） -->
                                <ui:SymbolIcon Symbol="Mic16" FontSize="14"
                                               Foreground="#FFA500"
                                               Visibility="{Binding IsMutedByHost, Converter={StaticResource BoolToVisConverter}}"/>
                            </Grid>
                        </ui:Button>
                        
                        <!-- 踢出按钮 -->
                        <ui:Button Appearance="Transparent"
                                   Padding="4"
                                   ToolTip="踢出房间"
                                   Command="{Binding DataContext.KickUserCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                   CommandParameter="{Binding}">
                            <ui:SymbolIcon Symbol="PersonDelete16"
                                           FontSize="14"
                                           Foreground="#FFA500"/>
                        </ui:Button>
                    </StackPanel>
                    
                    <!-- 未读数 -->
                    <Border Grid.Column="3"
                            VerticalAlignment="Center"
                            Visibility="{Binding HasUnread, Converter={StaticResource BoolToVisConverter}}">
                        <Border Background="#FFA500"
                                CornerRadius="10"
                                MinWidth="20"
                                Height="20"
                                Padding="6,0">
                            <TextBlock Text="{Binding UnreadCount}"
                                       Foreground="White"
                                       FontSize="11"
                                       FontWeight="Bold"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"/>
                        </Border>
                    </Border>
                </Grid>
            </Border>
        </DataTemplate>
    </UserControl.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <!-- 用户列表 -->
            <ColumnDefinition Width="250"/>
            <!-- 聊天区域 -->
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- 左侧：用户列表 -->
        <Border Grid.Column="0"
                BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                BorderThickness="0,0,1,0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- 标题 -->
                <Border Grid.Row="0" Padding="12,10">
                    <StackPanel Orientation="Horizontal">
                        <ui:SymbolIcon Symbol="People24" FontSize="18" Margin="0,0,8,0"/>
                        <TextBlock Text="联系人" FontWeight="SemiBold" FontSize="14"/>
                    </StackPanel>
                </Border>

                <!-- 搜索框 -->
                <Border Grid.Row="1" Padding="8,0,8,8">
                    <ui:TextBox x:Name="SearchTextBox"
                                PlaceholderText="搜索联系人..."
                                Icon="{ui:SymbolIcon Search24}"
                                TextChanged="SearchTextBox_TextChanged"/>
                </Border>

                <!-- 群聊选项 -->
                <Border Grid.Row="2" 
                        Padding="8,4"
                        Background="{DynamicResource ControlFillColorSecondaryBrush}"
                        Cursor="Hand"
                        x:Name="GroupChatItem"
                        MouseLeftButtonDown="GroupChatItem_Click">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <!-- 群聊图标 -->
                        <Border Grid.Column="0"
                                Width="36" Height="36"
                                CornerRadius="18"
                                Background="#4CAF50"
                                Margin="0,0,10,0">
                            <ui:SymbolIcon Symbol="PeopleTeam24" FontSize="16" Foreground="White"/>
                        </Border>
                        
                        <!-- 群聊标签 -->
                        <TextBlock Grid.Column="1"
                                   Text="群聊"
                                   FontSize="13"
                                   FontWeight="Medium"
                                   VerticalAlignment="Center"/>
                        
                        <!-- 未读消息计数 -->
                        <Border Grid.Column="2"
                                Visibility="{Binding HasGroupUnread, Converter={StaticResource BoolToVisConverter}}"
                                Margin="0,0,4,0">
                            <Border Background="#E81123"
                                    CornerRadius="10"
                                    MinWidth="20"
                                    Height="20"
                                    Padding="6,0">
                                <TextBlock Text="{Binding GroupUnreadCount}"
                                           Foreground="White"
                                           FontSize="11"
                                           FontWeight="Bold"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"/>
                            </Border>
                        </Border>
                    </Grid>
                </Border>

                <!-- 用户列表 -->
                <ListBox Grid.Row="3"
                         x:Name="UserListBox"
                         ItemsSource="{Binding ChatUsers}"
                         ItemTemplate="{StaticResource ChatUserTemplate}"
                         SelectedItem="{Binding SelectedChatUser}"
                         Background="Transparent"
                         BorderThickness="0"
                         SelectionChanged="UserListBox_SelectionChanged">
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="Padding" Value="0"/>
                            <Setter Property="Margin" Value="0"/>
                            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                            <Style.Triggers>
                                <Trigger Property="IsSelected" Value="True">
                                    <Setter Property="Background" Value="{DynamicResource ControlFillColorSecondaryBrush}"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </ListBox.ItemContainerStyle>
                </ListBox>
            </Grid>
        </Border>

        <!-- 右侧：聊天区域 -->
        <Grid Grid.Column="1">
            <Grid.RowDefinitions>
                <!-- 聊天对象信息 -->
                <RowDefinition Height="Auto"/>
                <!-- 消息列表 -->
                <RowDefinition Height="*"/>
                <!-- 输入区域 -->
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- 聊天对象信息 -->
            <Border Grid.Row="0"
                    Padding="12,10"
                    BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                    BorderThickness="0,0,0,1">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- 左侧：聊天对象名称和状态 -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock x:Name="ChatTargetName"
                                   Text="群聊"
                                   FontWeight="SemiBold"
                                   FontSize="14"/>
                        <TextBlock x:Name="ChatTargetStatus"
                                   Text=""
                                   FontSize="12"
                                   Opacity="0.6"
                                   Margin="8,0,0,0"
                                   VerticalAlignment="Center"/>
                    </StackPanel>
                    
                    <!-- 右侧按钮组 -->
                    <!-- 删除按钮（清空聊天记录） -->
                    <ui:Button Grid.Column="1"
                               Appearance="Transparent"
                               ToolTip="清空聊天记录"
                               Padding="6"
                               Margin="0,0,4,0"
                               VerticalAlignment="Center"
                               Command="{Binding ClearChatHistoryCommand}">
                        <ui:SymbolIcon Symbol="Delete24" FontSize="16"/>
                    </ui:Button>
                    
                    <!-- 保存按钮（导出聊天记录） -->
                    <ui:Button Grid.Column="2"
                               Appearance="Transparent"
                               ToolTip="导出聊天记录"
                               Padding="6"
                               Margin="0,0,4,0"
                               VerticalAlignment="Center"
                               Command="{Binding ExportChatHistoryCommand}">
                        <ui:SymbolIcon Symbol="Save24" FontSize="16"/>
                    </ui:Button>
                    
                    <!-- 图钉按钮（折叠聊天面板） -->
                    <ui:Button Grid.Column="3"
                               Appearance="Transparent"
                               ToolTip="折叠聊天面板"
                               Padding="6"
                               VerticalAlignment="Center"
                               Command="{Binding ChatCommand}">
                        <ui:SymbolIcon Symbol="Pin24" FontSize="16"/>
                    </ui:Button>
                </Grid>
            </Border>

            <!-- 消息列表 -->
            <ScrollViewer Grid.Row="1"
                          x:Name="MessagesScrollViewer"
                          VerticalScrollBarVisibility="Auto"
                          Padding="4">
                <ItemsControl x:Name="MessagesControl"
                              ItemsSource="{Binding CurrentMessages}"
                              ItemTemplate="{StaticResource ChatMessageTemplate}"/>
            </ScrollViewer>

            <!-- 输入区域 -->
            <Border Grid.Row="2"
                    Padding="12"
                    BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                    BorderThickness="0,1,0,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- 工具栏 -->
                    <StackPanel Grid.Row="0" 
                                Orientation="Horizontal" 
                                Margin="0,0,0,8">
                        <!-- 表情 -->
                        <ui:Button Appearance="Transparent"
                                   ToolTip="表情"
                                   Padding="8"
                                   CornerRadius="4,0,0,4"
                                   BorderThickness="1,1,0,1"
                                   Click="EmojiButton_Click">
                            <ui:SymbolIcon Symbol="Emoji24" FontSize="18"/>
                        </ui:Button>
                        
                        <!-- 图片 -->
                        <ui:Button Appearance="Transparent"
                                   ToolTip="发送图片"
                                   Padding="8"
                                   CornerRadius="0,0,0,0"
                                   Click="ImageButton_Click">
                            <ui:SymbolIcon Symbol="Image24" FontSize="18"/>
                        </ui:Button>
                        
                        <!-- 文件 -->
                        <ui:Button Appearance="Transparent"
                                   ToolTip="发送文件"
                                   Padding="8"
                                   CornerRadius="0,4,4,0"
                                   BorderThickness="0,1,1,1"
                                   Click="FileButton_Click">
                            <ui:SymbolIcon Symbol="Attach24" FontSize="18"/>
                        </ui:Button>
                    </StackPanel>

                    <!-- 输入框和发送按钮 -->
                    <Grid Grid.Row="1">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <ui:TextBox Grid.Column="0"
                                    x:Name="MessageInput"
                                    PlaceholderText="输入消息..."
                                    VerticalContentAlignment="Center"
                                    KeyDown="MessageInput_KeyDown">
                            <ui:TextBox.ContextMenu>
                                <ContextMenu>
                                    <MenuItem Header="粘贴图片" Click="PasteImageMenuItem_Click">
                                        <MenuItem.Icon>
                                            <ui:SymbolIcon Symbol="Image24" FontSize="16"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <Separator/>
                                    <MenuItem Header="粘贴" Command="ApplicationCommands.Paste">
                                        <MenuItem.Icon>
                                            <ui:SymbolIcon Symbol="ClipboardPaste24" FontSize="16"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <MenuItem Header="复制" Command="ApplicationCommands.Copy">
                                        <MenuItem.Icon>
                                            <ui:SymbolIcon Symbol="Copy24" FontSize="16"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <MenuItem Header="剩切" Command="ApplicationCommands.Cut">
                                        <MenuItem.Icon>
                                            <ui:SymbolIcon Symbol="Cut24" FontSize="16"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                </ContextMenu>
                            </ui:TextBox.ContextMenu>
                        </ui:TextBox>

                        <ui:Button Grid.Column="1"
                                   Appearance="Primary"
                                   Margin="8,0,0,0"
                                   Padding="16,8"
                                   Click="SendButton_Click">
                            <StackPanel Orientation="Horizontal">
                                <ui:SymbolIcon Symbol="Send24" FontSize="16" Margin="0,0,6,0"/>
                                <TextBlock Text="发送"/>
                            </StackPanel>
                        </ui:Button>
                    </Grid>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</UserControl>
