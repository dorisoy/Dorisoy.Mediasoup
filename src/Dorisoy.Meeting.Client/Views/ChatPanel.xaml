<UserControl x:Class="Dorisoy.Meeting.Client.Views.ChatPanel"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             xmlns:models="clr-namespace:Dorisoy.Meeting.Client.Models"
             Background="{DynamicResource ControlFillColorDefaultBrush}">

    <UserControl.Resources>
        <!-- 消息气泡模板 -->
        <DataTemplate x:Key="ChatMessageTemplate" DataType="{x:Type models:ChatMessage}">
            <Grid Margin="8,4">
                <!-- 自己发送的消息 -->
                <Border HorizontalAlignment="Right"
                        MaxWidth="280"
                        Visibility="{Binding IsFromSelf, Converter={StaticResource BoolToVisConverter}}">
                    <StackPanel>
                        <TextBlock Text="{Binding FormattedTime}"
                                   HorizontalAlignment="Right"
                                   FontSize="10"
                                   Opacity="0.5"
                                   Margin="0,0,0,2"/>
                        <Border Background="#0078D4"
                                CornerRadius="12,12,4,12"
                                Padding="12,8">
                            <!-- 文本消息 -->
                            <TextBlock Text="{Binding Content}"
                                       Foreground="White"
                                       TextWrapping="Wrap"
                                       FontSize="13"
                                       Visibility="{Binding MessageType, Converter={StaticResource TextMessageVisibilityConverter}}"/>
                        </Border>
                    </StackPanel>
                </Border>
                
                <!-- 他人发送的消息 -->
                <StackPanel HorizontalAlignment="Left"
                            Visibility="{Binding IsFromSelf, Converter={StaticResource InverseBoolToVisConverter}}">
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,2">
                        <TextBlock Text="{Binding SenderName}"
                                   FontSize="11"
                                   FontWeight="SemiBold"
                                   Opacity="0.7"
                                   Margin="0,0,8,0"/>
                        <TextBlock Text="{Binding FormattedTime}"
                                   FontSize="10"
                                   Opacity="0.5"/>
                    </StackPanel>
                    <Border Background="{DynamicResource ControlFillColorSecondaryBrush}"
                            CornerRadius="12,12,12,4"
                            Padding="12,8"
                            MaxWidth="280">
                        <!-- 文本消息 -->
                        <TextBlock Text="{Binding Content}"
                                   TextWrapping="Wrap"
                                   FontSize="13"/>
                    </Border>
                </StackPanel>
            </Grid>
        </DataTemplate>

        <!-- 用户列表模板 -->
        <DataTemplate x:Key="ChatUserTemplate" DataType="{x:Type models:ChatUser}">
            <Border Padding="8,6"
                    Cursor="Hand"
                    Background="Transparent">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- 头像 -->
                    <Border Grid.Column="0"
                            Width="36" Height="36"
                            CornerRadius="18"
                            Background="{DynamicResource ControlFillColorTertiaryBrush}"
                            Margin="0,0,10,0">
                        <TextBlock Text="{Binding DisplayName[0]}"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"
                                   FontSize="14"
                                   FontWeight="SemiBold"/>
                    </Border>
                    
                    <!-- 名称 -->
                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                        <TextBlock Text="{Binding DisplayName}"
                                   FontSize="13"
                                   FontWeight="Medium"/>
                        <TextBlock Text="{Binding LastMessage.Content}"
                                   FontSize="11"
                                   Opacity="0.6"
                                   TextTrimming="CharacterEllipsis"
                                   MaxWidth="120"/>
                    </StackPanel>
                    
                    <!-- 未读数 -->
                    <Border Grid.Column="2"
                            Background="#0078D4"
                            CornerRadius="10"
                            MinWidth="20" Height="20"
                            Padding="6,0"
                            Visibility="{Binding UnreadCount, Converter={StaticResource CountToVisibilityConverter}}">
                        <TextBlock Text="{Binding UnreadCount}"
                                   Foreground="White"
                                   FontSize="11"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"/>
                    </Border>
                </Grid>
            </Border>
        </DataTemplate>
    </UserControl.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <!-- 用户列表 -->
            <ColumnDefinition Width="200"/>
            <!-- 聊天区域 -->
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- 左侧：用户列表 -->
        <Border Grid.Column="0"
                BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                BorderThickness="0,0,1,0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- 标题 -->
                <Border Grid.Row="0" Padding="12,10">
                    <StackPanel Orientation="Horizontal">
                        <ui:SymbolIcon Symbol="People24" FontSize="18" Margin="0,0,8,0"/>
                        <TextBlock Text="联系人" FontWeight="SemiBold" FontSize="14"/>
                    </StackPanel>
                </Border>

                <!-- 群聊选项 -->
                <Border Grid.Row="1" 
                        Padding="8,4"
                        Background="{DynamicResource ControlFillColorSecondaryBrush}"
                        Cursor="Hand"
                        x:Name="GroupChatItem"
                        MouseLeftButtonDown="GroupChatItem_Click">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        
                        <Border Grid.Column="0"
                                Width="36" Height="36"
                                CornerRadius="18"
                                Background="#4CAF50"
                                Margin="0,0,10,0">
                            <ui:SymbolIcon Symbol="PeopleTeam24" FontSize="16" Foreground="White"/>
                        </Border>
                        
                        <TextBlock Grid.Column="1"
                                   Text="群聊"
                                   FontSize="13"
                                   FontWeight="Medium"
                                   VerticalAlignment="Center"/>
                    </Grid>
                </Border>

                <!-- 用户列表 -->
                <ListBox Grid.Row="2"
                         x:Name="UserListBox"
                         ItemsSource="{Binding ChatUsers}"
                         ItemTemplate="{StaticResource ChatUserTemplate}"
                         SelectedItem="{Binding SelectedChatUser}"
                         Background="Transparent"
                         BorderThickness="0"
                         SelectionChanged="UserListBox_SelectionChanged">
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="Padding" Value="0"/>
                            <Setter Property="Margin" Value="0"/>
                            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                            <Style.Triggers>
                                <Trigger Property="IsSelected" Value="True">
                                    <Setter Property="Background" Value="{DynamicResource ControlFillColorSecondaryBrush}"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </ListBox.ItemContainerStyle>
                </ListBox>
            </Grid>
        </Border>

        <!-- 右侧：聊天区域 -->
        <Grid Grid.Column="1">
            <Grid.RowDefinitions>
                <!-- 聊天对象信息 -->
                <RowDefinition Height="Auto"/>
                <!-- 消息列表 -->
                <RowDefinition Height="*"/>
                <!-- 输入区域 -->
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- 聊天对象信息 -->
            <Border Grid.Row="0"
                    Padding="12,10"
                    BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                    BorderThickness="0,0,0,1">
                <StackPanel Orientation="Horizontal">
                    <TextBlock x:Name="ChatTargetName"
                               Text="群聊"
                               FontWeight="SemiBold"
                               FontSize="14"/>
                    <TextBlock x:Name="ChatTargetStatus"
                               Text=""
                               FontSize="12"
                               Opacity="0.6"
                               Margin="8,0,0,0"
                               VerticalAlignment="Center"/>
                </StackPanel>
            </Border>

            <!-- 消息列表 -->
            <ScrollViewer Grid.Row="1"
                          x:Name="MessagesScrollViewer"
                          VerticalScrollBarVisibility="Auto"
                          Padding="4">
                <ItemsControl x:Name="MessagesControl"
                              ItemsSource="{Binding CurrentMessages}"
                              ItemTemplate="{StaticResource ChatMessageTemplate}"/>
            </ScrollViewer>

            <!-- 输入区域 -->
            <Border Grid.Row="2"
                    Padding="12"
                    BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                    BorderThickness="0,1,0,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- 工具栏 -->
                    <StackPanel Grid.Row="0" 
                                Orientation="Horizontal" 
                                Margin="0,0,0,8">
                        <!-- 表情 -->
                        <ui:Button Appearance="Transparent"
                                   ToolTip="表情"
                                   Padding="8"
                                   Click="EmojiButton_Click">
                            <ui:SymbolIcon Symbol="Emoji24" FontSize="18"/>
                        </ui:Button>
                        
                        <!-- 图片 -->
                        <ui:Button Appearance="Transparent"
                                   ToolTip="发送图片"
                                   Padding="8"
                                   Click="ImageButton_Click">
                            <ui:SymbolIcon Symbol="Image24" FontSize="18"/>
                        </ui:Button>
                        
                        <!-- 文件 -->
                        <ui:Button Appearance="Transparent"
                                   ToolTip="发送文件"
                                   Padding="8"
                                   Click="FileButton_Click">
                            <ui:SymbolIcon Symbol="Attach24" FontSize="18"/>
                        </ui:Button>
                    </StackPanel>

                    <!-- 输入框和发送按钮 -->
                    <Grid Grid.Row="1">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <ui:TextBox Grid.Column="0"
                                    x:Name="MessageInput"
                                    PlaceholderText="输入消息..."
                                    VerticalContentAlignment="Center"
                                    KeyDown="MessageInput_KeyDown"/>

                        <ui:Button Grid.Column="1"
                                   Appearance="Primary"
                                   Margin="8,0,0,0"
                                   Padding="16,8"
                                   Click="SendButton_Click">
                            <StackPanel Orientation="Horizontal">
                                <ui:SymbolIcon Symbol="Send24" FontSize="16" Margin="0,0,6,0"/>
                                <TextBlock Text="发送"/>
                            </StackPanel>
                        </ui:Button>
                    </Grid>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</UserControl>
